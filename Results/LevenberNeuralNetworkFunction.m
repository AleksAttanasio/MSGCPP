function [Y,Xf,Af] = myNeuralNetworkFunction(X,Xi,~)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 29-Mar-2017 11:41:33.
%
% [Y,Xf,Af] = myNeuralNetworkFunction(X,Xi,~) takes these arguments:
%
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 1xQ matrix, input #1 at timestep ts.
%
%   Xi = 1x20 cell 1, initial 20 input delay states.
%   Each Xi{1,ts} = 1xQ matrix, initial states for input #1.
%
%   Ai = 2x0 cell 2, initial 20 layer delay states.
%   Each Ai{1,ts} = 20xQ matrix, initial states for layer #1.
%   Each Ai{2,ts} = 1xQ matrix, initial states for layer #2.
%
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 1xQ matrix, output #1 at timestep ts.
%
%   Xf = 1x20 cell 1, final 20 input delay states.
%   Each Xf{1,ts} = 1xQ matrix, final states for input #1.
%
%   Af = 2x0 cell 2, final 0 layer delay states.
%   Each Af{1ts} = 20xQ matrix, final states for layer #1.
%   Each Af{2ts} = 1xQ matrix, final states for layer #2.
%
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1_xoffset = -100;
x1_step1_gain = 0.00191241157328827;
x1_step1_ymin = -1;

% Layer 1
b1 = [1.3282604050882878;-1.6748937969691327;2.3074936271251225;0.31596758926138524;0.024133875495781564;0.48061821802664628;0.32460900713652946;-0.052813373285571737;-0.063133475077332302;-0.062222459777953293;-0.38301828290565854;0.10986385777539638;0.22224075924294293;0.011879145177184683;-0.11646341142940386;-0.36858744916947989;-0.57292812974251461;-2.0004894172011558;-0.085347056743624403;-0.13361491344213564];
IW1_1 = [0.80740660925410357 0.41608616840280993 -1.3064386940857753 0.58467995011924423 0.47413871290164888 -0.67965106253193708 1.3499034237776737 -1.3448047131228851 0.66081673475156799 0.79270705232995142 -1.9580937220825305 1.3324812776831529 -0.16493408746822691 -0.88977444222229263 1.0644783053562039 -0.44282120972331268 0.43714401626649124 0.031193570566782951 -0.46605218260232001 -0.21364447433002309;0.39423350115889322 -0.31858353724560484 -5.1760697343945896 6.0450388956816559 -1.3817119124286616 0.11605605847079921 0.49792052475460846 -0.68890884721377454 0.44834378665515345 0.57218042022046078 -0.6735887965896582 0.1431779350130378 -0.052518357559247039 0.019513179022421192 0.049429069570117674 -0.40466023300018822 -0.096800048512953901 0.32483043004252138 -0.16539449536119083 0.084805521344522322;0.068019306597800422 0.068880120654710636 -3.4627167005026096 2.8777675235457054 -0.62981112751008084 -2.1960807335093104 2.5779710155512925 -0.92230763443084374 -0.73207058334856345 1.0428596600788644 -0.19524203852311811 -0.43057550016768475 0.63123426248061787 -0.49772508659832509 0.049055744541914172 0.20933533517289279 -0.13928187583370405 -0.34765750708383547 0.54789538451956754 0.15076695140288901;-0.80860409128853716 0.10011594257751166 -1.9635518651003925 1.6867837736519353 0.49260759411925137 -1.20546044629145 -42.566114567848203 43.633695698842146 -0.7059002305697023 0.084529496391893749 1.3291847148924856 -1.2221591813428678 0.59525108176081132 -0.6286230712119365 0.17546626168517732 0.27352020765403801 -0.25561632983804139 0.62569283849076496 -0.62305513013946978 0.64433306871090845;0.31864635551227827 1.3539145579976177 -2.9892666269875061 0.3477739472118806 1.6570148172330499 -1.3887092506102336 0.016458174400184412 1.1987328705741691 -1.2858171919453492 0.27884558107789492 1.5662026811000178 -1.6635124377112958 0.85391983344840483 0.16018086591520231 -0.77117198088754124 0.18667040890554956 -0.045083333180010426 1.0389319997890192 -0.98382008941158738 0.28329577358546776;-0.79344957716184528 0.5621443898847458 -0.12196251585366652 0.25780508158873339 -0.34551901165876514 0.036290255381076608 -0.38789919109090537 0.58815118845633363 -0.48304015858375782 -0.29679870254540958 0.86125664639916855 -0.60060990690085125 0.31803644234499862 0.28897940124860677 -0.52132378163948934 0.33979742209167701 -0.42727984080998982 -0.027070565835202103 0.42389343577421279 -0.010401143016706324;-0.79787784659825134 0.10617061021925003 -2.0565391930454853 1.7763848295831877 0.47100537516928964 -1.2134681262560814 -42.664708627658051 43.726354464560892 -0.70686508787754698 0.065264180887493334 1.37200865708227 -1.237059207033157 0.59285874564909924 -0.63910962439825014 0.19148429496067135 0.26908207913024684 -0.26610107912270192 0.64867694656898933 -0.63422938954397778 0.65744407844458308;-0.11517126994855531 -0.224795210293709 0.7254425851677071 -0.093030759594557297 -0.31480749128909824 0.14631353474459785 -0.0081345338057280045 -0.074950373694819258 -0.11912912479228593 0.078879296929458873 0.33632980729676437 -0.3989298802827731 0.1719022884592078 0.052203134985068837 -0.22760721600526834 0.021471817423085959 0.040078951975512367 0.030598181919384751 0.023575088923765683 -0.037302258843711238;3.3658826863003442 -2.1386449387644122 -0.14105961627431551 -55.045644867829814 53.73760678572318 1.326978180319921 -0.42891699687457269 -0.43731725599908589 -0.042114077827866234 -0.0056091554746867233 0.21565695133222812 0.20050757038199163 -0.44619958931799203 0.075200654093463146 -0.58931207641882399 0.98107356823819891 -0.21543726725089743 0.43024724588998148 -2.4564346828143147 2.0249542593519512;-6.5736202071615946 1.011374291260126 5.7374469399771817 -1.7482748305604123 0.21722584657595542 0.27100735835358919 0.027490556960002417 -0.074305807865836307 0.052160044420815718 -0.033614003097540548 0.08894483784146201 -0.0095259696776498412 0.12464044666409839 -0.053633929850752299 0.14030306674487522 -0.11223699261483934 0.17961005053454585 -0.15735280623180808 -0.034819032577358612 0.35536241816765651;1.7139591633998341 1.401648339237795 1.8014333494083199 -1.2495749118079924 0.50596296420557785 0.26133003804341232 -0.89627498478059253 0.42767964034256167 -0.01821535614468615 0.45900497163853771 -0.71894618611196326 0.2440999713928966 -0.45168471842199959 -0.082897121165746809 0.66859859737990479 -0.21796408800963421 -0.78103804266345744 2.0408507804568523 -1.3334551368622503 -3.8938172796761892;0.38731677129615733 -2.8252195764232098 -0.10932422673067549 54.37319072814438 -51.863449905390091 -0.63935453726000357 0.303961432119988 0.0076179456374363998 0.7332997405715096 0.031183557554837517 -0.57961853677301955 0.22747091296755026 0.26902075035357509 -0.15281035612825983 0.3429899703512781 -0.65273416836176434 0.30761134900591586 -0.3215885380930249 1.8071305597255967 -1.9645805555874136;-7.0758818431060924 0.34568211579867042 3.7343558835258026 -2.6387643061505983 0.88627762648096342 0.7478766922298733 -0.1240244757138502 -0.7256229253173877 0.49360435810840997 -0.17631905946598547 0.0072228901996279141 0.35447605273092242 1.0947696810910019 -0.78269732320741758 -0.55964190804196634 0.35549378014898031 0.62355414437595813 -1.4648555014996996 0.81833991770855918 4.021718342073588;-0.15815387360665592 0.024051455032733746 0.55619387137271081 -0.25100792326054144 -0.067723791777678594 0.067431261950670784 0.19715179920343737 -0.35104359051932799 0.028964817698271732 0.21810192456736682 -0.14965361172222241 0.0085574614736688669 0.071712790200018028 -0.16003905163649301 0.065474653581748643 -0.068394216511981132 0.11603618006204522 0.025467239473837531 -0.088832686642067421 -0.067865325864150228;-2.6363722019574216 -1.5283607914547508 -0.33105235865279353 2.1822400960610264 1.2607767197731092 0.051165989446308464 -0.31737552514387563 0.44875914705646064 0.11033402365803259 -0.10096169706758629 0.90519291324199036 -0.26325610147589418 0.14944642950109022 0.24975193434798584 0.066320117795272915 -0.21853004579169716 0.31395541330692345 0.11703895494522573 -0.47405323343979666 -0.35913870910392992;-0.33592278197914993 0.38272088260810244 -0.59527344748381728 0.57317897044147359 -0.14728275830397594 -0.22937029267797085 0.16782682013373826 0.045377681832425215 -0.19181753605779156 0.073261966918071186 0.094997017108849127 -0.13362149558701528 0.18999848807966369 -0.016659765580328043 -0.12482341996539965 0.13875144340045362 -0.16912575462476048 -0.060422460344233937 0.20435631297297308 -0.05960639886007086;0.26492023174147961 8.7616571956464462 12.97194799711118 -8.1166221389135593 3.347110340908241 0.41982341655610517 2.4339051808816974 0.18411114035641526 1.3981227874931601 -12.114870871375405 -14.860953041029115 -10.187716431545709 -8.1387490197525363 -3.0048739306094818 10.947881685716801 5.1234458439618953 5.0354970657803779 1.9771488921583598 1.8083073915164625 3.8743126800648744;2.6036863822960203 -4.1935598240654803 -3.3818341584910678 6.8510393541497674 -2.2370676668882434 0.29264364142857946 0.45804349734910216 -0.83989675495835325 1.2135967627667044 0.33867052885341248 -1.1560787201778633 0.65769582918729164 -0.72201818173675814 -0.1828560684885697 0.94921761278731975 -1.1642433320662293 -0.0034900108218394385 1.2483484205305981 -1.1125515534270702 -0.060460408133609977;2.0675799079386321 -0.27321379065025653 -1.8618698163374403 1.3988504778889825 -1.2856656572927139 0.90241554939273405 43.71102547750305 -44.770148568843304 0.72340692222716507 -0.50061297682688566 -0.37252504017909355 0.92301548376488574 -0.66153372631420193 0.37119466342196672 0.26562639853445996 -0.43236039105123303 0.022212487030785398 -0.063603891051093847 0.36738600918181596 -0.27478422725268176;-0.33738031932114493 0.93215926433074481 -0.81223643367029696 0.36262821791031757 0.12884196522914074 -0.37901073957291037 0.41707299323792085 -0.21560874248414522 -0.18490193880621128 0.25043771165686374 -0.3058264308527463 0.20178947798414273 0.19868482496769854 -0.269878238201886 0.12122153850612484 0.11033090969737734 -0.16584522865210549 -0.037184108562090368 0.11635461563527137 -0.085323732778658498];

% Layer 2
b2 = -0.15198208621634332;
LW2_1 = [0.34607857306049067 0.16492476120236937 -0.11203928229931895 -3.7565480302392089 -0.12566691860786727 -1.039782806736393 3.6212889094352643 4.2165258013081068 -0.052023551383127413 -0.10750532461497929 0.03736491700269453 -0.050491200250052472 0.036828066368446447 -4.9927859338867062 0.047800295966383438 -3.2019368851321173 0.0037500532103738973 -0.10989043642274091 -0.13403544602904635 2.7467390268087595];

% Output 1
y1_step1_ymin = -1;
y1_step1_gain = 0.00191241157328827;
y1_step1_xoffset = -100;

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;
if (nargin < 2), error('Initial input states Xi argument needed.'); end

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},2); % samples/series
elseif ~isempty(Xi)
    Q = size(Xi{1},2);
else
    Q = 0;
end

% Input 1 Delay States
Xd1 = cell(1,21);
for ts=1:20
    Xd1{ts} = mapminmax_apply(Xi{1,ts},x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+19,21)+1;
    
    % Input 1
    Xd1{xdts} = mapminmax_apply(X{1,ts},x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
    
    % Layer 1
    tapdelay1 = cat(1,Xd1{mod(xdts-[1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20]-1,21)+1});
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*tapdelay1);
    
    % Layer 2
    a2 = repmat(b2,1,Q) + LW2_1*a1;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a2,y1_step1_gain,y1_step1_xoffset,y1_step1_ymin);
end

% Final Delay States
finalxts = TS+(1: 20);
xits = finalxts(finalxts<=20);
xts = finalxts(finalxts>20)-20;
Xf = [Xi(:,xits) X(:,xts)];
Af = cell(2,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings_gain,settings_xoffset,settings_ymin)
y = bsxfun(@minus,x,settings_xoffset);
y = bsxfun(@times,y,settings_gain);
y = bsxfun(@plus,y,settings_ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings_gain,settings_xoffset,settings_ymin)
x = bsxfun(@minus,y,settings_ymin);
x = bsxfun(@rdivide,x,settings_gain);
x = bsxfun(@plus,x,settings_xoffset);
end
